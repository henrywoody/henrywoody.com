---
import Layout from "../../layouts/Layout.astro";
import CanvasProject from "../../components/CanvasProject.astro";
import ExternalLink from "../../components/ExternalLink.astro";

const rules = [
	{
		generates: "the stem",
		probability: 0.01,
		matrix: [
			[0, 0],
			[0, 0.16],
		],
		constantVector: [0, 0],
	},
	{
		generates: "successively small leaflets",
		probability: 0.85,
		matrix: [
			[0.85, 0.04],
			[-0.04, 0.85],
		],
		constantVector: [0, 1.6],
	},
	{
		generates: "the largest left-hand leaflet",
		probability: 0.07,
		matrix: [
			[0.2, -0.26],
			[0.23, 0.22],
		],
		constantVector: [0, 1.6],
	},
	{
		generates: "the largest right-hand leaflet",
		probability: 0.07,
		matrix: [
			[-0.15, 0.28],
			[0.26, 0.24],
		],
		constantVector: [0, 0.44],
	},
];
---

<Layout title="Barnsley Fern | Henry Woody">
	<CanvasProject title="Barnsley Fern">
		<form slot="controls" class="controls">
			<div class="input-container">
				<label for="renderSpeed">Render Speed</label>
				<input id="renderSpeed" type="number" name="renderSpeed" value="75" />
			</div>

			<div class="input-container">
				<button type="button" id="reset-btn">Reset</button>
			</div>
		</form>

		<Fragment slot="description">
			<p>
				The Barnsley fern is a fractal designed to look like <ExternalLink
					href="https://en.wikipedia.org/wiki/Asplenium_adiantum-nigrum">black spleenwort</ExternalLink
				>. The fractal is named for <ExternalLink href="https://en.wikipedia.org/wiki/Michael_Barnsley"
					>Michael Barnsley</ExternalLink
				>.
			</p>

			<p>
				Starting with an initial coordinate position (on the canvas), the Barnsley fern is generated by
				probabilistically applying one of several matrix transformations to the current position and making a mark at
				the current position.
			</p>

			<p>The construction rules are as follows:</p>

			<p>Start with an initial position of (0, 0).</p>

			{
				rules.map((rule) => (
					<div class="rule">
						<p>
							To generate {rule.generates}, with probability {rule.probability}, use:
						</p>

						<div class="math-block math-row">
							<span class="variable">f(x, y)</span> <span>=</span>
							<table class="matrix">
								<tr class="matrix-row">
									<td>{rule.matrix[0][0].toFixed(2)}</td>
									<td>{rule.matrix[0][1].toFixed(2)}</td>
								</tr>
								<tr class="matrix-row">
									<td>{rule.matrix[1][0].toFixed(2)}</td>
									<td>{rule.matrix[1][1].toFixed(2)}</td>
								</tr>
							</table>
							<table class="matrix">
								<tr class="matrix-row">
									<td>
										<span class="variable">x</span>
									</td>
								</tr>
								<tr class="matrix-row">
									<td>
										<span class="variable">y</span>
									</td>
								</tr>
							</table>
							<span>+</span>
							<table class="matrix">
								<tr class="matrix-row">
									<td>{rule.constantVector[0].toFixed(2)}</td>
								</tr>
								<tr class="matrix-row">
									<td>{rule.constantVector[1].toFixed(2)}</td>
								</tr>
							</table>
						</div>
					</div>
				))
			}

			<p>
				Check out the <ExternalLink href="https://en.wikipedia.org/wiki/Barnsley_fern">Wikipedia article</ExternalLink> for
				more.
			</p>
		</Fragment>
	</CanvasProject>
</Layout>

<script>
	const canvas = document.querySelector("canvas")!;
	const ctx = canvas.getContext("2d")!;
	const renderSpeedInput = document.getElementById("renderSpeed") as HTMLInputElement;
	const resetBtn = document.getElementById("reset-btn")!;

	const color = "#0c9c0c";
	let x = 0;
	let y = 0;

	function resizeCanvas() {
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}

	function setUp() {
		resizeCanvas();
		x = 0;
		y = 0;
	}

	function getImageDimensions() {
		const ratio = 1;
		const ratioWidth = canvas.height * ratio;
		const ratioHeight = canvas.width / ratio;

		let imgWidth, imgHeight;
		if (canvas.width > ratioWidth) {
			imgWidth = ratioWidth;
			imgHeight = canvas.height;
		} else {
			imgWidth = canvas.width;
			imgHeight = ratioHeight;
		}

		const horizontalPadding = (canvas.width - imgWidth) / 2;
		const verticalPadding = (canvas.height - imgHeight) / 2;
		return { imgWidth, imgHeight, horizontalPadding, verticalPadding };
	}

	function drawPixel(px: number, py: number, dims: ReturnType<typeof getImageDimensions>) {
		ctx.fillRect(
			(dims.imgWidth * (px + 3)) / 6 + dims.horizontalPadding,
			dims.imgHeight - dims.imgHeight * ((py + 2) / 14) + dims.verticalPadding,
			1,
			1,
		);
	}

	function getNextPosition(cx: number, cy: number) {
		const rand = Math.random();
		let matrix: number[][], constantVector: number[];

		if (rand < 0.01) {
			matrix = [
				[0, 0],
				[0, 0.16],
			];
			constantVector = [0, 0];
		} else if (rand < 0.86) {
			matrix = [
				[0.85, 0.04],
				[-0.04, 0.85],
			];
			constantVector = [0, 1.6];
		} else if (rand < 0.93) {
			matrix = [
				[0.2, -0.26],
				[0.23, 0.22],
			];
			constantVector = [0, 1.6];
		} else {
			matrix = [
				[-0.15, 0.28],
				[0.26, 0.24],
			];
			constantVector = [0, 0.44];
		}

		let nextX = matrix[0][0] * cx + matrix[0][1] * cy + constantVector[0];
		let nextY = matrix[1][0] * cx + matrix[1][1] * cy + constantVector[1];
		return { nextX, nextY };
	}

	function update() {
		ctx.fillStyle = color;
		ctx.strokeStyle = color;
		const imageDimensions = getImageDimensions();
		const speed = Number(renderSpeedInput.value) || 0;

		for (let i = 0; i < speed; i++) {
			drawPixel(x, y, imageDimensions);
			const { nextX, nextY } = getNextPosition(x, y);
			x = nextX;
			y = nextY;
		}
	}

	function run() {
		update();
		window.requestAnimationFrame(run);
	}

	resetBtn.addEventListener("click", () => {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		setUp();
	});

	window.addEventListener("resize", resizeCanvas);
	setUp();
	run();
</script>

<style>
	.rule:last-of-type {
		margin-bottom: 2rem;
	}

	.math-block .variable {
		font-style: italic;
	}

	.math-row {
		display: flex;
		flex-flow: row;
		align-items: center;
	}

	.math-row > * {
		margin-right: 0.5rem;
		display: inline-block;
	}

	.matrix {
		--border-width: 1px;
		border: var(--border-width) solid var(--color);
		position: relative;
		--border-hook-size: 3px;
	}

	.matrix::before,
	.matrix::after {
		content: "";
		width: calc(100% - 2 * var(--border-hook-size));
		height: var(--border-width);
		background-color: var(--background-color);
		display: block;
		position: absolute;
		left: var(--border-hook-size);
	}

	.matrix::before {
		bottom: calc(-1 * var(--border-width));
	}

	.matrix::after {
		top: calc(-1 * var(--border-width));
	}

	.matrix td {
		padding: 0.1rem 0.15rem;
	}
</style>
